<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Eco de las Palabras - Neuro Play World</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-blue: #0066CC;
            --cyan-light: #00B4D8;
            --cyan-bright: #0099FF;
            --red-color: #EF4444;
            --green-color: #10B981;
            --light-bg: #F0F9FF;
            --white: #FFFFFF;
            --dark-text: #1F2937;
            --shadow: 0 4px 12px rgba(0, 102, 204, 0.15);
            --border-radius: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #0066CC 0%, #00B4D8 50%, #0099FF 100%);
            color: var(--dark-text);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .game-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 15px 20px;
            box-shadow: var(--shadow);
        }

        .back-button button {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--dark-text);
            font-weight: 600;
            transition: color 0.3s ease;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        .back-button button:hover {
            color: var(--primary-blue);
        }

        .game-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-blue);
        }

        .game-info {
            font-weight: 600;
            color: var(--primary-blue);
        }

        .game-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .progress-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 15px 20px;
            box-shadow: var(--shadow);
            border: 4px solid var(--primary-blue);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .progress-bar {
            height: 12px;
            background-color: #E5E7EB;
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-blue) 0%, var(--cyan-bright) 100%);
            border-radius: 6px;
            transition: width 0.5s ease;
            width: 20%;
        }

        .audio-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--shadow);
            text-align: center;
            border: 4px solid var(--primary-blue);
        }

        .audio-card h2 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .image-display {
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
        }

        .image-display img {
            max-width: 300px;
            max-height: 300px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .difficulty-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .difficulty-badge.easy {
            background-color: #D1FAE5;
            color: #065F46;
        }

        .difficulty-badge.medium {
            background-color: #FEF3C7;
            color: #92400E;
        }

        .difficulty-badge.hard {
            background-color: #FEE2E2;
            color: #991B1B;
        }

        .audio-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .audio-button {
            padding: 15px 25px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .audio-button:hover:not(:disabled) {
            transform: scale(1.05);
        }

        .audio-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .audio-button.primary {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--cyan-bright) 100%);
            box-shadow: 0 4px 15px rgba(0, 102, 204, 0.3);
        }

        .audio-button.primary:hover:not(:disabled) {
            box-shadow: 0 8px 25px rgba(0, 102, 204, 0.4);
            transform: translateY(-3px);
        }

        .audio-button.red {
            background-color: var(--red-color);
        }

        .audio-button.red:hover:not(:disabled) {
            background-color: #DC2626;
        }

        .audio-button.recording {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .similarity-meter {
            margin-bottom: 20px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            background-color: #F3F4F6;
            padding: 15px;
            border-radius: 12px;
            display: none;
        }

        .similarity-label {
            font-weight: 700;
            margin-bottom: 8px;
            text-align: left;
        }

        .similarity-bar {
            height: 20px;
            background-color: #E5E7EB;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .similarity-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-blue) 0%, var(--cyan-bright) 100%);
            border-radius: 10px;
            transition: width 1s ease;
            width: 0%;
        }

        .similarity-fill.success {
            background: linear-gradient(90deg, var(--green-color) 0%, #34D399 100%);
        }

        .similarity-fill.warning {
            background: linear-gradient(90deg, #F59E0B 0%, #FBBF24 100%);
        }

        .similarity-fill.error {
            background: linear-gradient(90deg, var(--red-color) 0%, #F87171 100%);
        }

        .similarity-text {
            font-weight: 700;
            text-align: right;
            font-size: 16px;
        }

        .recorded-text {
            background-color: #EFF6FF;
            border: 2px solid var(--primary-blue);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 15px;
            display: none;
        }

        .recorded-text.show {
            display: block;
        }

        .recorded-text p:first-child {
            font-size: 12px;
            color: #6B7280;
            margin-bottom: 4px;
        }

        .recorded-text p:last-child {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-blue);
        }

        .feedback {
            font-size: 18px;
            font-weight: 700;
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
            display: none;
        }

        .feedback.show {
            display: block;
        }

        .feedback.correct {
            background: linear-gradient(135deg, var(--green-color) 0%, #34D399 100%);
            color: white;
        }

        .feedback.incorrect {
            background-color: var(--red-color);
            color: white;
        }

        .game-completed {
            text-align: center;
        }

        .final-score {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--cyan-bright) 100%);
            color: white;
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .final-score h2 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .score-number {
            font-size: 48px;
            font-weight: 800;
        }

        .options-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .option-button {
            padding: 15px 20px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }

        .option-button.primary {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--cyan-bright) 100%);
        }

        .option-button.primary:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 102, 204, 0.3);
        }

        .option-button.blue {
            background-color: #3B82F6;
        }

        .option-button.blue:hover {
            background-color: #2563EB;
            transform: scale(1.05);
        }

        .instructions-card {
            background-color: rgba(0, 102, 204, 0.08);
            border-radius: var(--border-radius);
            padding: 15px 20px;
            border: 2px solid var(--primary-blue);
            text-align: center;
            color: var(--primary-blue);
            font-weight: 600;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .game-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .image-display img {
                max-width: 200px;
                max-height: 200px;
            }

            .audio-controls {
                flex-direction: column;
                align-items: center;
            }

            .options-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <header class="game-header">
            <div class="back-button">
                <button onclick="goToMainPage()">
                    <i class="fas fa-arrow-left"></i> Volver
                </button>
            </div>
            <h1 class="game-title">El Eco de las Palabras</h1>
            <div class="game-info">
                <span id="score-display">0 puntos</span>
            </div>
        </header>

        <main class="game-content">
            <!-- Progress -->
            <div class="progress-card">
                <div class="progress-header">
                    <span>Ronda <span id="current-round">1</span> de <span id="total-rounds">5</span></span>
                    <span id="score">0 puntos</span>
                </div>
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
            </div>

            <!-- Audio Display -->
            <div class="audio-card" id="audio-card">
                <h2>Repite la palabra</h2>
                
                <div id="difficulty-badge" class="difficulty-badge"></div>

                <div id="image-display" class="image-display">
                    <img id="current-image" src="" alt="Imagen para asociar">
                </div>
                
                <div class="audio-controls">
                    <button id="play-button" class="audio-button primary">
                        <i class="fas fa-volume-up"></i> Escuchar palabra
                    </button>
                    <button id="record-button" class="audio-button red">
                        <i class="fas fa-microphone"></i> Grabar mi voz
                    </button>
                </div>

                <div id="recorded-text" class="recorded-text">
                    <p>Lo que grabaste:</p>
                    <p id="recorded-text-content"></p>
                </div>
                
                <div id="similarity-meter" class="similarity-meter">
                    <div class="similarity-label">Similitud:</div>
                    <div class="similarity-bar">
                        <div id="similarity-fill" class="similarity-fill"></div>
                    </div>
                    <div id="similarity-text" class="similarity-text">0%</div>
                </div>
                
                <div id="feedback" class="feedback">
                    <span id="feedback-text"></span>
                </div>
            </div>

            <!-- Instructions -->
            <div class="instructions-card">
                <p>
                    üí° <span style="font-weight: 700;">Tip:</span> Escucha atentamente la palabra y trata de repetirla lo m√°s parecido posible.
                </p>
            </div>
        </main>
    </div>

    <script>
        // ========================
        // PRONUNCIATION ANALYZER INTEGRADO
        // ========================

        // Base de datos de fonemas espa√±oles
        const SPANISH_PHONEMES = {
            'a': { ipa: 'a' },
            'e': { ipa: 'e' },
            'i': { ipa: 'i' },
            'o': { ipa: 'o' },
            'u': { ipa: 'u' },
            's': { ipa: 's' },
            'l': { ipa: 'l' },
            'n': { ipa: 'n' },
            'r': { ipa: '…æ' },
            'rr': { ipa: 'r' },
            't': { ipa: 't' },
            'b': { ipa: 'b' },
            'd': { ipa: 'd' },
            'g': { ipa: 'g' },
            'p': { ipa: 'p' },
            'c': { ipa: 'k' },
            'z': { ipa: 'Œ∏' },
            'j': { ipa: 'x' },
            'y': { ipa: ' ù' },
            'v': { ipa: 'b' },
            'm': { ipa: 'm' },
            'f': { ipa: 'f' },
            'h': { ipa: '‚àÖ' },
            'ch': { ipa: ' ß' },
            'll': { ipa: ' ù' }
        };

        // Diccionario de palabras
        const WORD_PHONEME_DATABASE = {
            'sol': { phonemes: ['s', 'o', 'l'], difficulty: 'easy' },
            'luna': { phonemes: ['l', 'u', 'n', 'a'], difficulty: 'easy' },
            'estrella': { phonemes: ['e', 's', 't', 'r', 'e', 'y', 'a'], difficulty: 'medium' },
            'nube': { phonemes: ['n', 'u', 'b', 'e'], difficulty: 'easy' },
            'lluvia': { phonemes: ['y', 'u', 'v', 'i', 'a'], difficulty: 'hard' },
            '√°rbol': { phonemes: ['a', 'r', 'b', 'o', 'l'], difficulty: 'medium' }
        };

        // Clase PronunciationAnalyzer
        class PronunciationAnalyzer {
            constructor() {
                this.userHistory = {
                    successfulPhonemes: [],
                    failedPhonemes: [],
                    attempts: [],
                    sessionStats: {
                        totalAttempts: 0,
                        totalScore: 0,
                        averageScore: 0
                    }
                };
            }

            analyze(targetWord, recordedText) {
                if (!WORD_PHONEME_DATABASE[targetWord]) {
                    return this.getDefaultAnalysis();
                }

                const targetPhonemes = WORD_PHONEME_DATABASE[targetWord].phonemes;
                const recordedPhonemes = this.extractPhonemes(recordedText);
                const similarity = this.calculateSimilarity(targetWord, recordedText);
                const detailedAnalysis = this.analyzeByPhoneme(targetWord, recordedText);
                const errors = this.detectSpecificErrors(targetWord, recordedText);
                const score = this.generateScore(similarity, errors, detailedAnalysis);

                const attempt = {
                    timestamp: new Date(),
                    targetWord: targetWord,
                    recordedText: recordedText,
                    score: score,
                    similarity: similarity,
                    errors: errors,
                    detailedAnalysis: detailedAnalysis
                };

                this.userHistory.attempts.push(attempt);
                this.updateHistoricalData(attempt);

                return {
                    score: score,
                    similarity: similarity,
                    errors: errors,
                    detailedAnalysis: detailedAnalysis,
                    feedback: this.generateFeedback(score, errors),
                    nextExercise: this.generateAdaptiveExercise()
                };
            }

            extractPhonemes(text) {
                const cleaned = text.toLowerCase().trim();
                const phonemes = [];
                
                for (let i = 0; i < cleaned.length; i++) {
                    const char = cleaned[i];
                    const nextChar = cleaned[i + 1];
                    
                    if ((char === 'c' && nextChar === 'h') ||
                        (char === 'l' && nextChar === 'l') ||
                        (char === 'r' && nextChar === 'r')) {
                        phonemes.push(char + nextChar);
                        i++;
                    } else if (SPANISH_PHONEMES[char]) {
                        phonemes.push(char);
                    }
                }
                return phonemes;
            }

            calculateSimilarity(target, recorded) {
                const targetLower = target.toLowerCase();
                const recordedLower = recorded.toLowerCase();
                
                const maxLen = Math.max(targetLower.length, recordedLower.length);
                let matches = 0;
                
                for (let i = 0; i < Math.min(targetLower.length, recordedLower.length); i++) {
                    if (targetLower[i] === recordedLower[i]) {
                        matches++;
                    }
                }
                
                if (recordedLower.indexOf(targetLower) !== -1 || targetLower.indexOf(recordedLower) !== -1) {
                    matches = Math.min(maxLen, matches + 15);
                }
                
                return Math.round((matches / maxLen) * 100);
            }

            analyzeByPhoneme(targetWord, recordedText) {
                const targetData = WORD_PHONEME_DATABASE[targetWord];
                const targetPhonemes = targetData.phonemes;
                const recordedPhonemes = this.extractPhonemes(recordedText);
                const analysis = [];
                
                for (let i = 0; i < targetPhonemes.length; i++) {
                    const phoneme = targetPhonemes[i];
                    const recordedPhoneme = recordedPhonemes[i];
                    const accuracy = phoneme === recordedPhoneme ? 100 : 40;
                    
                    analysis.push({
                        expected: phoneme,
                        recorded: recordedPhoneme || 'omitted',
                        accuracy: accuracy
                    });
                }
                
                return analysis;
            }

            detectSpecificErrors(targetWord, recordedText) {
                const targetLower = targetWord.toLowerCase();
                const recordedLower = recordedText.toLowerCase();
                const errors = [];
                
                if (recordedLower.length < targetLower.length) {
                    errors.push({ type: 'Omission', description: 'Omiti√≥ sonidos' });
                }
                
                return errors;
            }

            generateScore(similarity, errors, detailedAnalysis) {
                const correctPhonemes = detailedAnalysis.filter(p => p.accuracy >= 80).length;
                const totalPhonemes = detailedAnalysis.length;
                const phonemeAccuracy = totalPhonemes > 0 ? (correctPhonemes / totalPhonemes) * 100 : 0;
                
                const errorPenalty = Math.min(errors.length * 20, 100);
                const score = Math.round((similarity * 0.4) + (phonemeAccuracy * 0.4) + ((100 - errorPenalty) * 0.2));
                
                return Math.max(0, Math.min(100, score));
            }

            generateFeedback(score, errors) {
                let emoji = '';
                let level = '';
                let messages = [];
                
                if (score >= 90) {
                    emoji = 'üéâ';
                    level = 'excellent';
                    messages.push('¬°Excelente pronunciaci√≥n!');
                } else if (score >= 75) {
                    emoji = 'üëç';
                    level = 'good';
                    messages.push('Muy bien, necesitas peque√±as mejoras');
                } else if (score >= 50) {
                    emoji = 'üîÑ';
                    level = 'okay';
                    messages.push('Intenta de nuevo, m√°s lentamente');
                } else {
                    emoji = 'üí™';
                    level = 'needswork';
                    messages.push('Necesitas practicar este sonido m√°s');
                }
                
                return {
                    emoji: emoji,
                    level: level,
                    score: score,
                    messages: messages,
                    advice: this.getAdviceByScore(score)
                };
            }

            getAdviceByScore(score) {
                if (score >= 90) return '¬°Pasemos a un sonido m√°s dif√≠cil!';
                if (score >= 70) return 'Repite una vez m√°s, con m√°s cuidado';
                if (score >= 50) return 'Escucha bien la palabra y hazlo m√°s lento';
                return 'Pide ayuda a tu maestro/a';
            }

            generateAdaptiveExercise() {
                return { type: 'normal' };
            }

            updateHistoricalData(attempt) {
                this.userHistory.sessionStats.totalAttempts++;
                this.userHistory.sessionStats.totalScore += attempt.score;
                this.userHistory.sessionStats.averageScore = 
                    Math.round(this.userHistory.sessionStats.totalScore / this.userHistory.sessionStats.totalAttempts);
            }

            getProgressReport() {
                return {
                    totalAttempts: this.userHistory.sessionStats.totalAttempts,
                    averageScore: this.userHistory.sessionStats.averageScore
                };
            }

            getDefaultAnalysis() {
                return {
                    score: 0,
                    similarity: 0,
                    errors: [],
                    detailedAnalysis: [],
                    feedback: {
                        emoji: '‚ùå',
                        level: 'error',
                        messages: ['Error al procesar'],
                        advice: 'Intenta de nuevo'
                    }
                };
            }
        }

        // ========================
        // SCRIPT PRINCIPAL DEL JUEGO
        // ========================

        let currentRound = 0;
        let score = 0;
        let currentWord = null;
        let isRecording = false;
        let hasPlayed = false;
        let difficulty = 'normal';
        let analyzer = new PronunciationAnalyzer();
        let recognition;

        const words = [
            { src: "https://tse1.mm.bing.net/th/id/OIP.z589HEF6wuRZZR-B9C49RQHaFK?rs=1&pid=ImgDetMain&o=7&rm=3", name: "sol", difficulty: 'easy' },
            { src: "https://img.freepik.com/vector-premium/icono-luna-lindo-estilo-dibujos-animados_74102-7166.jpg?w=2000", name: "luna", difficulty: 'easy' },
            { src: "https://img.freepik.com/vector-premium/estrella-dibujada-mano-plana-elegante-mascota-personaje-dibujos-animados-dibujo-pegatina-icono-concepto-aislado_730620-302755.jpg", name: "estrella", difficulty: 'medium' },
            { src: "https://static.vecteezy.com/system/resources/previews/024/190/108/non_2x/cute-cartoon-cloud-kawaii-weather-illustrations-for-kids-free-png.png", name: "nube", difficulty: 'easy' },
            { src: "https://img.freepik.com/fotos-premium/estilo-ilustracion-vectorial-lluvia-dibujos-animados_750724-13162.jpg", name: "lluvia", difficulty: 'hard' },
            { src: "https://static.vecteezy.com/system/resources/previews/008/132/083/non_2x/green-tree-cartoon-isolated-on-white-background-illustration-of-green-tree-cartoon-free-vector.jpg", name: "√°rbol", difficulty: 'medium' },
        ];

        const totalRounds = 5;

        document.addEventListener('DOMContentLoaded', function() {
            setupSpeechRecognition();
            setupEventListeners();
            startNewRound();
        });

        function setupSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'es-ES';
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript.toLowerCase().trim();
                    console.log('Grabado:', transcript);
                    analyzePronounciation(transcript);
                };

                recognition.onerror = function(event) {
                    console.error('Error:', event.error);
                    showFeedback('Error al grabar', false);
                    stopRecording();
                };
            } else {
                console.warn('Web Speech API no soportada');
                alert('Tu navegador no soporta reconocimiento de voz. Usa Chrome, Edge o Safari.');
            }
        }

        function setupEventListeners() {
            document.getElementById('play-button').addEventListener('click', playWord);
            document.getElementById('record-button').addEventListener('click', toggleRecording);
        }

        function startNewRound() {
            let filteredWords = words;
            if (difficulty === 'easy') {
                filteredWords = words.filter(w => w.difficulty === 'easy');
            } else if (difficulty === 'hard') {
                filteredWords = words.filter(w => w.difficulty === 'hard');
            }

            const randomWord = filteredWords[Math.floor(Math.random() * filteredWords.length)];
            currentWord = randomWord;
            hasPlayed = false;
            isRecording = false;
            
            updateUI();
            
            setTimeout(() => playWord(), 1000);
        }

        function updateUI() {
            document.getElementById('current-round').textContent = currentRound + 1;
            document.getElementById('total-rounds').textContent = totalRounds;
            document.getElementById('score').textContent = score + ' puntos';
            document.getElementById('score-display').textContent = score + ' puntos';
            
            const progress = ((currentRound + 1) / totalRounds) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
            
            document.getElementById('current-image').src = currentWord.src;
            
            const badgeElement = document.getElementById('difficulty-badge');
            let diffText = 'Normal';
            if (difficulty === 'easy') diffText = 'F√°cil';
            if (difficulty === 'hard') diffText = 'Dif√≠cil';
            badgeElement.textContent = 'Dificultad: ' + diffText;
            badgeElement.className = 'difficulty-badge ' + difficulty;
            
            document.getElementById('similarity-meter').style.display = 'none';
            document.getElementById('similarity-fill').style.width = '0%';
            document.getElementById('similarity-text').textContent = '0%';
            document.getElementById('similarity-fill').className = 'similarity-fill';
            
            const recordButton = document.getElementById('record-button');
            recordButton.innerHTML = '<i class="fas fa-microphone"></i> Grabar mi voz';
            recordButton.className = 'audio-button red';
            
            document.getElementById('feedback').classList.remove('show');
            document.getElementById('recorded-text').classList.remove('show');
        }

        function playWord() {
            if (!currentWord) return;
            
            const playButton = document.getElementById('play-button');
            playButton.innerHTML = '<i class="fas fa-volume-up"></i> Reproduciendo...';
            playButton.disabled = true;
            
            const utterance = new SpeechSynthesisUtterance(currentWord.name);
            utterance.lang = 'es-ES';
            utterance.rate = difficulty === 'hard' ? 0.6 : 0.8;
            utterance.pitch = 1;
            
            utterance.onend = function() {
                playButton.innerHTML = '<i class="fas fa-volume-up"></i> Escuchar palabra';
                playButton.disabled = false;
                hasPlayed = true;
            };
            
            speechSynthesis.speak(utterance);
        }

        function toggleRecording() {
            if (!hasPlayed) {
                showFeedback('Primero escucha la palabra', false);
                return;
            }
            
            const recordButton = document.getElementById('record-button');
            
            if (!isRecording) {
                isRecording = true;
                recordButton.innerHTML = '<i class="fas fa-stop"></i> Detener grabaci√≥n';
                recordButton.className = 'audio-button red recording';
                recognition.start();
            } else {
                stopRecording();
            }
        }

        function stopRecording() {
            isRecording = false;
            const recordButton = document.getElementById('record-button');
            recordButton.innerHTML = '<i class="fas fa-microphone"></i> Analizando...';
            recordButton.className = 'audio-button red';
            recognition.stop();
        }

        function analyzePronounciation(transcript) {
            const result = analyzer.analyze(currentWord.name, transcript);
            const similarity = result.score;
            
            const recordedTextElement = document.getElementById('recorded-text');
            document.getElementById('recorded-text-content').textContent = '"' + transcript + '"';
            recordedTextElement.classList.add('show');
            
            document.getElementById('similarity-meter').style.display = 'block';
            document.getElementById('similarity-fill').style.width = similarity + '%';
            document.getElementById('similarity-text').textContent = similarity + '%';
            
            const fillElement = document.getElementById('similarity-fill');
            fillElement.className = 'similarity-fill';
            if (similarity >= 70) {
                fillElement.classList.add('success');
            } else if (similarity >= 50) {
                fillElement.classList.add('warning');
            } else {
                fillElement.classList.add('error');
            }

            const isCorrect = similarity >= 70;
            const pointsEarned = Math.floor(similarity / 10);

            if (isCorrect) {
                score += pointsEarned;
                const feedbackMsg = result.feedback.emoji + ' ' + result.feedback.messages[0];
                showFeedback(feedbackMsg, true);
                
                if (similarity >= 90 && difficulty !== 'hard') {
                    difficulty = 'hard';
                }
            } else {
                const feedbackMsg = result.feedback.emoji + ' ' + result.feedback.messages[0];
                showFeedback(feedbackMsg, false);
                
                if (similarity < 50 && difficulty !== 'easy') {
                    difficulty = 'easy';
                }
            }

            document.getElementById('score').textContent = score + ' puntos';
            document.getElementById('score-display').textContent = score + ' puntos';

            setTimeout(function() {
                if (currentRound + 1 >= totalRounds) {
                    completeGame();
                } else {
                    currentRound++;
                    startNewRound();
                }
            }, 2500);
        }

        function showFeedback(message, isCorrect) {
            const feedbackElement = document.getElementById('feedback');
            const feedbackText = document.getElementById('feedback-text');
            
            feedbackText.textContent = message;
            
            if (isCorrect) {
                feedbackElement.className = 'feedback correct show';
            } else {
                feedbackElement.className = 'feedback incorrect show';
            }
        }

        function completeGame() {
            const audioCard = document.getElementById('audio-card');
            const promedio = Math.round(score / totalRounds);
            
            let html = '<div class="game-completed">';
            html += '<h2 style="margin-bottom: 20px; color: #0066CC;">¬°Juego Completado!</h2>';
            html += '<div class="final-score">';
            html += '<h2>Tu puntaje final:</h2>';
            html += '<div class="score-number">' + score + '</div>';
            html += '<p>puntos</p>';
            html += '</div>';
            html += '<p style="color: #6B7280; margin-bottom: 20px;">Promedio: ' + promedio + '% por ronda</p>';
            html += '<div class="options-container">';
            html += '<button class="option-button primary" onclick="location.reload()">';
            html += '<i class="fas fa-redo"></i> Jugar de Nuevo';
            html += '</button>';
            html += '<button class="option-button blue" onclick="goToMainPage()">';
            html += '<i class="fas fa-arrow-left"></i> Volver al Men√∫';
            html += '</button>';
            html += '</div>';
            html += '</div>';
            
            audioCard.innerHTML = html;
        }

        function goToMainPage() {
            window.location.href = 'https://plekdev.github.io/BlueMinds/selectores/selector-auditivo.html';
        }
    </script>
</body>
</html>