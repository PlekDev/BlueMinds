<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz para Ni√±os - BlueMinds</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../css/quiz-ninos.css">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
</head>       
<body>
    <div id="app">
        <div id="quiz-container" class="container">
            <div class="card">
                <div class="progress-bar-bg">
                    <div id="progress-bar" class="progress-bar-fill" style="width: 0%">
                        <span id="progress-text">0%</span>
                    </div>
                </div>

                <h2 id="question-title" class="question-title"></h2>
                <p id="question-subtitle" class="question-subtitle"></p>

                <div id="question-content"></div>

                <button id="verify-button" class="action-button" onclick="checkAnswer()" disabled>
                    VERIFICAR RESPUESTA
                </button>

                <div id="feedback"></div>
            </div>
        </div>

        <div id="results-container" class="hidden">
            <div class="card results-container">
                <div class="trophy-icon">
                    <i class="fas fa-trophy" style="font-size: 4rem; color: white;"></i>
                </div>
                <h2 class="results-title">¬°Excelente Trabajo! üéâ</h2>
                <p style="font-size: 1.125rem; color: var(--gray-600); margin-bottom: 2rem;">
                    Has completado todas las preguntas
                </p>
                
                <div class="results-stats">
                    <div class="stat-box">
                        <div class="stat-number" id="total-questions">20</div>
                        <div class="stat-label">Preguntas</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="correct-answers">0</div>
                        <div class="stat-label">Correctas</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="completion-time">0m</div>
                        <div class="stat-label">Tiempo</div>
                    </div>
                </div>

                <div style="background: var(--gray-50); padding: 1.5rem; border-radius: 1rem; margin-top: 2rem;">
                    <h3 style="color: var(--gray-800); margin-bottom: 1rem;">üìä An√°lisis de Aprendizaje</h3>
                    <div id="learning-analysis" style="text-align: left; color: var(--gray-700);"></div>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button onclick="location.reload()" class="action-button" style="flex: 1;">
                        Volver a Empezar
                    </button>
                    <button onclick="goToMainApp()" class="action-button" style="flex: 1; background: linear-gradient(135deg, var(--blue-500), var(--blue-600));">
                        Ir a la App
                    </button>
                </div>
            </div>
        </div>
    </div>
     <script src="../api.js"></script>
 <script src="../js/auth-guard.js"></script>
    <script>
        let isProcessing = false;
        let currentQuestionType = '';
        let draggedValue = null
        let currentQuestionIndex = 0;
        let answers = [];
        let selectedAnswer = null;
        let showFeedback = false;
        let score = 0;
        let startTime = Date.now();
        let currentAudio = null;
        let questionStartTime = Date.now();
        const verifyBtn = document.getElementById('verify-button');
        let currentSessionId = null;

        // Definici√≥n de preguntas seg√∫n el documento
        const questions = [
            // Pregunta 1 - Nivel 1 (Visual): Secuencia de im√°genes
            {
                type: 'sequence',
                nivel: 1,
                learningStyle: 'visual',
                question: 'Ordena la secuencia correcta',
                subtitle: 'Arrastra los emojis en el orden correcto',
                sequence: ['üë§', 'üçΩÔ∏è', 'üçé'],
                options: ['üçé', 'üë§', 'üçΩÔ∏è'],
                correct: ['üë§', 'üçΩÔ∏è', 'üçé']
            },
            // Pregunta 2 - Nivel 1 (Visual): Completar secuencia
            {
                type: 'complete-sequence',
                nivel: 1,
                learningStyle: 'visual',
                question: '¬øQu√© imagen falta?',
                subtitle: 'Selecciona la imagen que completa la secuencia',
                sequence: ['üö∂', 'üè´', '?', 'ü™ë'],
                options: [
                    { emoji: 'üöó', value: 'carro' },
                    { emoji: 'üéí', value: 'mochila' },
                    { emoji: 'üìö', value: 'libros' }
                ],
                correct: 'libros'
            },
            // Pregunta 3 - Nivel 2 (Visual): Imagen a palabra
            {
                type: 'image-to-word',
                nivel: 2,
                learningStyle: 'visual',
                question: 'Selecciona la palabra correcta',
                subtitle: 'Mira la imagen y elige la palabra',
                image: 'üå∏',
                options: ['Flor', 'Helado', 'Vaca'],
                correct: 'Flor'
            },
            // Pregunta 4 - Nivel 3 (Visual): Palabra a imagen
            {
                type: 'word-to-image',
                nivel: 3,
                learningStyle: 'visual',
                question: '¬øLa imagen corresponde a la palabra?',
                subtitle: 'Verifica si cada imagen es correcta',
                pairs: [
                    { word: 'Vaca', image: 'üêÆ', correct: true },
                    { word: 'Manzana', image: 'üçé', correct: true },
                    { word: 'Escuela', image: 'üè´', correct: true }
                ],
                currentPair: 0
            },
            // Pregunta 5 - Nivel 1 (Auditivo): Audio incompleto
            {
                type: 'sound-complete',
                nivel: 1,
                learningStyle: 'auditivo',
                question: 'Escucha y completa',
                subtitle: 'Elige la imagen correcta',
                audioText: 'Yo como manza',
                soundFile: null,
                options: [
                    { emoji: 'üçé', label: 'Manzana', value: 'manzana' },
                    { emoji: 'üê±', label: 'Gato', value: 'gato' },
                    { emoji: 'üè†', label: 'Casa', value: 'casa' }
                ],
                correct: 'manzana'
            },
            // Pregunta 6 - Nivel 2 (Auditivo): Ordenar palabras seg√∫n audio
            {
                type: 'order-words',
                nivel: 2,
                learningStyle: 'auditivo',
                question: 'Ordena las palabras',
                subtitle: 'Escucha y ordena para formar la oraci√≥n',
                audioText: 'Pap√° come manzana',
                soundFile: null,
                words: ['Manzana', 'come', 'Pap√°'],
                correct: ['Pap√°', 'come', 'Manzana']
            },
            // Pregunta 7 - Nivel 1 (Auditivo): Reconocimiento de sonido animal
            {
                type: 'sound',
                nivel: 1,
                learningStyle: 'auditivo',
                question: 'Escucha y selecciona el animal',
                subtitle: 'Presiona el bot√≥n para escuchar',
                soundFile: '../sonidos/vaca.mp3',
                options: [
                    { animal: 'Vaca', emoji: 'üêÆ', value: 'vaca' },
                    { animal: 'Cerdo', emoji: 'üê∑', value: 'cerdo' },
                    { animal: 'Pollo', emoji: 'üêî', value: 'pollo' }
                ],
                correct: 'vaca'
            },
            // Pregunta 8 - Nivel 2 (Auditivo): Reconocimiento de sonido
            {
                type: 'sound',
                nivel: 2,
                learningStyle: 'auditivo',
                question: 'Escucha y selecciona el animal',
                subtitle: 'Presiona el bot√≥n para escuchar',
                soundFile: '../sonidos/perro.mp3',
                options: [
                    { animal: 'Perro', emoji: 'üêï', value: 'perro' },
                    { animal: 'Gato', emoji: 'üêà', value: 'gato' },
                    { animal: 'P√°jaro', emoji: 'üê¶', value: 'pajaro' }
                ],
                correct: 'perro'
            },
            // Pregunta 9 - Nivel 3 (Auditivo)
            {
                type: 'sound',
                nivel: 3,
                learningStyle: 'auditivo',
                question: 'Escucha y selecciona el animal',
                subtitle: 'Presiona el bot√≥n para escuchar',
                soundFile: '../sonidos/gato.mp3',
                options: [
                    { animal: 'Le√≥n', emoji: 'ü¶Å', value: 'leon' },
                    { animal: 'Gato', emoji: 'üêà', value: 'gato' },
                    { animal: 'Tigre', emoji: 'üêØ', value: 'tigre' }
                ],
                correct: 'gato'
            },
            // Preguntas 10-14: Kinest√©sico/T√°ctil (simuladas con interacci√≥n)
            {
                type: 'drag-sequence',
                nivel: 1,
                learningStyle: 'kinestesico',
                question: 'Arrastra y ordena',
                subtitle: 'Toca y arrastra cada emoji al lugar correcto',
                sequence: ['üåÖ', '‚òÄÔ∏è', 'üåô'],
                options: ['üåô', '‚òÄÔ∏è', 'üåÖ'],
                correct: ['üåÖ', '‚òÄÔ∏è', 'üåô']
            },
            {
                type: 'image-to-word',
                nivel: 2,
                learningStyle: 'kinestesico',
                question: 'Toca la respuesta correcta',
                subtitle: 'Mira y selecciona la palabra',
                image: 'üöó',
                options: ['Carro', 'Casa', 'Comida'],
                correct: 'Carro'
            },
            {
                type: 'complete-sequence',
                nivel: 2,
                learningStyle: 'kinestesico',
                question: 'Completa tocando',
                subtitle: 'Toca la imagen correcta',
                sequence: ['üçû', 'üßà', '?', 'üç¥'],
                options: [
                    { emoji: 'ü•õ', value: 'leche' },
                    { emoji: 'üî™', value: 'cuchillo' },
                    { emoji: 'üßÇ', value: 'sal' }
                ],
                correct: 'cuchillo'
            },
            {
                type: 'word-to-image',
                nivel: 3,
                learningStyle: 'kinestesico',
                question: 'Verifica tocando',
                subtitle: '¬øLa imagen es correcta?',
                pairs: [
                    { word: 'Pelota', image: '‚öΩ', correct: true },
                    { word: 'Libro', image: 'üìö', correct: true }
                ],
                currentPair: 0
            },
            {
                type: 'drag-sequence',
                nivel: 3,
                learningStyle: 'kinestesico',
                question: 'Organiza arrastrando',
                subtitle: 'Del m√°s peque√±o al m√°s grande',
                sequence: ['üêú', 'üêï', 'üêò'],
                options: ['üêò', 'üêú', 'üêï'],
                correct: ['üêú', 'üêï', 'üêò']
            },
            // Preguntas 15-20: Lectoescritura
            {
                type: 'image-to-word',
                nivel: 1,
                learningStyle: 'lectoescritura',
                question: 'Lee y selecciona',
                subtitle: 'Mira la imagen y elige la palabra escrita',
                image: '‚òÄÔ∏è',
                options: ['Sol', 'Luna', 'Estrella'],
                correct: 'Sol'
            },
            {
                type: 'order-words',
                nivel: 2,
                learningStyle: 'lectoescritura',
                question: 'Ordena la oraci√≥n',
                subtitle: 'Toca las palabras en orden',
                audioText: 'El gato come pescado',
                soundFile: null,
                words: ['pescado', 'gato', 'come', 'El'],
                correct: ['El', 'gato', 'come', 'pescado']
            },
            {
                type: 'image-to-word',
                nivel: 2,
                learningStyle: 'lectoescritura',
                question: 'Lee la palabra',
                subtitle: 'Selecciona la palabra que corresponde',
                image: 'üå≥',
                options: ['√Årbol', 'Flor', 'Pasto'],
                correct: '√Årbol'
            },
            {
                type: 'complete-sequence',
                nivel: 3,
                learningStyle: 'lectoescritura',
                question: 'Completa la secuencia',
                subtitle: 'Lee y selecciona',
                sequence: ['üìñ', '‚úèÔ∏è', '?', 'üéì'],
                options: [
                    { emoji: 'üìù', value: 'escribir' },
                    { emoji: 'üéÆ', value: 'jugar' },
                    { emoji: 'üçï', value: 'comer' }
                ],
                correct: 'escribir'
            },
            {
                type: 'word-to-image',
                nivel: 3,
                learningStyle: 'lectoescritura',
                question: 'Verifica la palabra',
                subtitle: '¬øLa imagen corresponde?',
                pairs: [
                    { word: 'Mariposa', image: 'ü¶ã', correct: true },
                    { word: 'Nube', image: '‚òÅÔ∏è', correct: true }
                ],
                currentPair: 0
            },
            {
                type: 'order-words',
                nivel: 3,
                learningStyle: 'lectoescritura',
                question: 'Forma la oraci√≥n',
                subtitle: 'Ordena las palabras correctamente',
                audioText: 'Mar√≠a juega en el parque',
                soundFile: null,
                words: ['juega', 'parque', 'el', 'en', 'Mar√≠a'],
                correct: ['Mar√≠a', 'juega', 'en', 'el', 'parque']
            }
        ];
        const recommendations = {
        visual: "Se recomienda el uso de pictogramas y agendas visuales para las tareas diarias.",
        auditivo: "El refuerzo mediante instrucciones verbales claras y rimas facilitar√° su retenci√≥n.",
        kinestesico: "Aprende mejor a trav√©s de la manipulaci√≥n de objetos y el movimiento.",
        lectoescritura: "Aprende mejor con s√≠mbolos gr√°ficos y estructuras de palabras."
    };

    // Cargar progreso al iniciar
    async function loadQuizProgress() {
        try {
            const response = await fetch(`${api.baseURL}/quiz/progress`, {
                headers: api._getHeaders()
            });
            if (!response.ok) throw new Error('Error al obtener progreso');
            const data = await response.json();
            console.log(data);
            if (data.progress && data.progress.id) {
                currentSessionId = data.progress.id; 
            }
            if (data.progress && !data.progress.is_completed) {
                currentQuestionIndex = Math.min(
                    data.progress.current_question_index,
                    questions.length - 1
                );
                if (currentQuestionIndex >= questions.length) {
                    alert('¬°Parece que ya completaste este quiz! Cargando resultados...');
                    return;
                }
                alert(`¬°Bienvenido de nuevo! Continuamos desde la pregunta ${currentQuestionIndex + 1}`);
            }
        } catch (err) {
            console.error('Error cargando progreso del quiz de ni√±os:', err);
        }
        render();
    }

    // Variables por tipo de pregunta
    let sequenceAnswer = [];
    let wordOrderAnswer = [];
    let pairAnswers = [];

    function playSound() {
        const current = questions[currentQuestionIndex];
        if (current.soundFile) {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }
            currentAudio = new Audio(current.soundFile);
            currentAudio.play().catch(error => console.log('Error reproduciendo audio:', error));
        } else if (current.audioText) {
            const utterance = new SpeechSynthesisUtterance(current.audioText);
            utterance.lang = 'es-ES';
            utterance.rate = 0.9;
            speechSynthesis.speak(utterance);
        }
    }

    function handleSelection(value) {
        selectedAnswer = value;
        document.getElementById('verify-button').disabled = false;
        render();
    }

    function handleSequenceClick(index, emoji) {
        const current = questions[currentQuestionIndex];
        if (!sequenceAnswer.includes(emoji)) {
            sequenceAnswer[index] = emoji;
            updateVerifyButtonState();
            render();
        }
    }

    function handleWordClick(word) {
        const index = wordOrderAnswer.indexOf(word);
        if (index > -1) {
            wordOrderAnswer.splice(index, 1);
        } else {
            const current = questions[currentQuestionIndex];
            if (wordOrderAnswer.length < current.correct.length) {
                wordOrderAnswer.push(word);
            }
        }
        updateVerifyButtonState();
        render();
    }

    function handlePairAnswer(answer) {
        const current = questions[currentQuestionIndex];
        pairAnswers.push(answer);

        // Feedback inmediato por pareja
        showFeedback = true;
        document.getElementById('feedback').innerHTML = `
            <div class="feedback-box ${answer ? 'correct' : 'incorrect'}">
                <i class="fas fa-${answer ? 'check-circle' : 'times-circle'}" style="font-size: 2rem; color: ${answer ? 'var(--green-600)' : 'var(--red-500)'}"></i>
                <div style="margin-left: 1rem;">
                    <strong>${answer ? '¬°Correcto!' : 'Incorrecto'}</strong><br>
                    ${answer ? 'Bien visto' : 'Revisa la imagen de nuevo'}
                </div>
            </div>
        `;

        if (pairAnswers.length < current.pairs.length) {
            current.currentPair++;
            render(); // Avanza a siguiente pareja
        } else {
            // Todas las parejas terminadas ‚Üí habilitar bot√≥n para terminar (si es √∫ltima pregunta) o siguiente
            selectedAnswer = pairAnswers.every(a => a === true);
            document.getElementById('verify-button').disabled = false;
            if (currentQuestionIndex === questions.length - 1) {
                document.getElementById('verify-button').textContent = 'TERMINAR QUIZ';
                document.getElementById('verify-button').onclick = completeGame;
            } else {
                document.getElementById('verify-button').textContent = 'SIGUIENTE PREGUNTA';
                document.getElementById('verify-button').onclick = nextQuestion;
            }
        }
    }

async function checkAnswer() {
          if(isProcessing){
            return;
          }
          isProcessing = true;
          verifyBtn.disabled = true;
    const current = questions[currentQuestionIndex];
    const responseTimeMs = Date.now() - questionStartTime;

    let isCorrect = false;

    if (['sequence', 'drag-sequence', 'complete-sequence'].includes(current.type)) {
        let userAnswer;
        if (current.type === 'complete-sequence') {
            userAnswer = sequenceAnswer[0];
        } else {
            userAnswer = sequenceAnswer;
        }
        isCorrect = JSON.stringify(userAnswer) === JSON.stringify(current.correct);
    } else if (current.type === 'order-words') {
        isCorrect = JSON.stringify(wordOrderAnswer) === JSON.stringify(current.correct);
    } else if (current.type === 'word-to-image') {
        // Para word-to-image: todas las parejas deben ser correctas
        isCorrect = pairAnswers.every(a => a === true);
    } else {
        isCorrect = selectedAnswer === current.correct || selectedAnswer === true;
    }

    if (isCorrect) score++;

    // Guardar respuesta por √≠ndice
    answers[currentQuestionIndex] = {
        questionIndex: currentQuestionIndex,
        nivel: current.nivel,
        learningStyle: current.learningStyle,
        correct: isCorrect,
        answer: selectedAnswer || sequenceAnswer || wordOrderAnswer || pairAnswers || [],
        responseTimeMs
    };

    console.log(`Respuesta guardada en √≠ndice ${currentQuestionIndex} ‚Üí total: ${Object.keys(answers).length}`);

    try {
            await api.saveQuizResponse({
            quiz_session_id: currentSessionId, // Enviamos el ID de sesi√≥n
            question_index: currentQuestionIndex, // Con guion bajo
            question_type: current.type,
            learning_style: current.learningStyle,
            nivel: current.nivel,
            answer: selectedAnswer || sequenceAnswer || wordOrderAnswer || pairAnswers || [],
            is_correct: isCorrect,
            response_time_ms: responseTimeMs
        });
    } catch (err) {
        console.error('Error guardando respuesta:', err);
    }

    showFeedback = true;
    document.getElementById('feedback').innerHTML = `
        <div class="feedback-box ${isCorrect ? 'correct' : 'incorrect'}">
            <i class="fas fa-${isCorrect ? 'check-circle' : 'times-circle'}" style="font-size: 2rem; color: ${isCorrect ? 'var(--green-600)' : 'var(--red-500)'}"></i>
            <div>
                <div style="font-weight: 700; font-size: 1.25rem; margin-bottom: 0.5rem;">
                    ${isCorrect ? '¬°Muy bien! ‚ú®' : 'Respuesta registrada üìù'}
                </div>
                <div style="color: var(--gray-600);">
                    ${isCorrect ? 'Excelente trabajo, sigamos adelante' : 'Continuamos con la siguiente pregunta'}
                </div>
            </div>
        </div>
    `;

    if (isCorrect) {
        confetti({
            particleCount: 100,
            spread: 70,
            origin: { y: 0.6 },
            colors: ['#3b82f6', '#60a5fa', '#93c5fd']
        });
    }


    // Deshabilitar temporalmente durante feedback
    verifyBtn.disabled = true;

    // Si es la √∫ltima pregunta ‚Üí completar autom√°ticamente
    if (currentQuestionIndex === questions.length - 1) {
        setTimeout(() => {
            completeGame();
        }, 1500);
    } else {
        // Habilitar bot√≥n para siguiente
        verifyBtn.textContent = 'SIGUIENTE PREGUNTA';
        verifyBtn.onclick = nextQuestion;
        verifyBtn.disabled = false;
    }
    setTimeout(() => {
          isProcessing = false;
          if (currentQuestionIndex !== questions.length - 1) {
              verifyBtn.disabled = false;
          }
      }, 1500);
}
function nextQuestion() {
    if (currentQuestionIndex < questions.length - 1) {
        currentQuestionIndex++;
        const current = questions[currentQuestionIndex];
        selectedAnswer = null;
        pairAnswers = [];
        showFeedback = false;

        // Reinicio de estados
        if (['sequence', 'drag-sequence', 'complete-sequence'].includes(current.type)) {
            let slots = current.correct ? current.correct.length : 1;
            if (current.sequence) {
                slots = current.sequence.filter(s => s === '?').length || slots;
            }
            sequenceAnswer = new Array(slots).fill(null);
        } else if (current.type === 'order-words') {
            wordOrderAnswer = new Array(current.correct.length).fill(null);
        }

        document.getElementById('feedback').innerHTML = '';
        const verifyBtn = document.getElementById('verify-button');
        verifyBtn.textContent = 'VERIFICAR RESPUESTA';
        verifyBtn.onclick = checkAnswer;
        verifyBtn.disabled = true;

        if (current.type === 'word-to-image') {
            current.currentPair = 0;
        }

        questionStartTime = Date.now();
        render();
    } else {
        console.log('√öltima pregunta: esperando que checkAnswer complete autom√°ticamente');
    }
}
async function completeGame() {
    const endTime = Date.now();
    const totalTimeSeconds = Math.round((endTime - startTime) / 1000);
    const timeInMinutes = Math.round(totalTimeSeconds / 60);

    const styleNames = {
        visual: 'üëÅÔ∏è Visual',
        auditivo: 'üëÇ Auditivo',
        kinestesico: '‚úã Kinest√©sico',
        lectoescritura: 'üìñ Lectoescritura',
        'No detectado': 'No detectado'
    };

    try {
        console.log(`Enviando ${answers.length} respuestas al backend...`);
        console.log('Score calculado localmente antes de enviar:', answers.filter(a => a && a.correct).length);
        const response = await fetch(`${api.baseURL}/quiz/complete`, {
            method: 'POST',
            headers: api._getHeaders(),
            body: JSON.stringify({ answers })
        });

        console.log('Respuesta backend:', response.status);

        if (!response.ok) {
            const errData = await response.json().catch(() => ({}));
            throw new Error(errData.error || `Error del servidor: ${response.status}`);
        }

        const data = await response.json();

        score = data.score || score;
        bestStyle = data.bestStyle || 'No detectado';
        suggestedLevel = data.suggestedLevel || 1;
        const learningStats = data.learningStats || {};
        const recommendations = data.recommendations || [];

        document.getElementById('quiz-container').classList.add('hidden');
        document.getElementById('results-container').classList.remove('hidden');

        document.getElementById('correct-answers').textContent = score;
        document.getElementById('completion-time').textContent = timeInMinutes + 'm';

        let analysisHTML = `
            <p style="margin-bottom: 1rem;"><strong>üéØ Estilo de aprendizaje predominante:</strong> ${styleNames[bestStyle] || bestStyle}</p>
            <p style="margin-bottom: 1rem;"><strong>üìä Nivel sugerido:</strong> Nivel ${suggestedLevel}</p>
        `;

        if (Object.keys(learningStats).length > 0) {
            analysisHTML += `
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid var(--gray-300);">
                    <p style="font-weight: 600; margin-bottom: 0.5rem;">Desglose por estilo:</p>
            `;
            for (let style in learningStats) {
                const stats = learningStats[style];
                const percentage = stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0;
                analysisHTML += `
                    <div style="margin-bottom: 0.5rem;">
                        ${styleNames[style] || style}: ${stats.correct}/${stats.total} (${percentage}%)
                    </div>
                `;
            }
            analysisHTML += `</div>`;
        }

        if (recommendations.length > 0) {
            analysisHTML += `
                <div class="analysis-item" style="margin-top: 1.5rem;">
                    <strong>Recomendaciones personalizadas:</strong><br>
                    ${recommendations.map(rec => `‚Ä¢ ${rec}<br>`).join('')}
                </div>
            `;
        }

        document.getElementById('learning-analysis').innerHTML = analysisHTML;

        if (score >= 15) {
            confetti({
                particleCount: 150,
                spread: 90,
                origin: { y: 0.6 }
            });
        }

        localStorage.setItem('blueminds_test_completed', 'true');
        localStorage.setItem('blueminds_user_type', 'child');
        localStorage.setItem('blueminds_learning_style', bestStyle);
        localStorage.setItem('blueminds_suggested_level', suggestedLevel);
        localStorage.setItem('blueminds_score', score);

    } catch (err) {
        console.error('Error en completeGame (backend):', err);
        alert('Error al conectar con el servidor. Mostrando c√°lculo local...');

        const learningStats = {
            visual: { correct: 0, total: 0 },
            auditivo: { correct: 0, total: 0 },
            kinestesico: { correct: 0, total: 0 },
            lectoescritura: { correct: 0, total: 0 }
        };

        const levelStats = {
            1: { correct: 0, total: 0 },
            2: { correct: 0, total: 0 },
            3: { correct: 0, total: 0 }
        };

        let validAnswers = 0;
        answers.forEach(answer => {
            if (answer) {
                const style = answer.learningStyle;
                const level = answer.nivel;
                if (style && learningStats[style]) {
                    learningStats[style].total++;
                    if (answer.correct) learningStats[style].correct++;
                }
                if (level && levelStats[level]) {
                    levelStats[level].total++;
                    if (answer.correct) levelStats[level].correct++;
                }
                if (style || level) validAnswers++;
            }
        });

        let bestStyle = 'No detectado';
        let bestPercentage = 0;
        if (validAnswers > 0) {
            for (let style in learningStats) {
                const percentage = (learningStats[style].total > 0)
                    ? (learningStats[style].correct / learningStats[style].total) * 100
                    : 0;
                if (percentage > bestPercentage) {
                    bestPercentage = percentage;
                    bestStyle = style;
                }
            }
        }

        let suggestedLevel = 1;
        for (let level in levelStats) {
            const percentage = (levelStats[level].total > 0)
                ? (levelStats[level].correct / levelStats[level].total) * 100
                : 0;
            if (percentage >= 60) {
                suggestedLevel = Math.max(suggestedLevel, parseInt(level));
            }
        }

        document.getElementById('quiz-container').classList.add('hidden');
        document.getElementById('results-container').classList.remove('hidden');

        document.getElementById('correct-answers').textContent = score;
        document.getElementById('completion-time').textContent = timeInMinutes + 'm';

        let analysisHTML = `
            <p style="margin-bottom: 1rem;"><strong>üéØ Estilo de aprendizaje predominante (temporal):</strong> ${styleNames[bestStyle]}</p>
            <p style="margin-bottom: 1rem;"><strong>üìä Nivel sugerido:</strong> Nivel ${suggestedLevel}</p>
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid var(--gray-300);">
                <p style="font-weight: 600; margin-bottom: 0.5rem;">Desglose por estilo:</p>
        `;

        for (let style in learningStats) {
            const stats = learningStats[style];
            const percentage = stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0;
            analysisHTML += `
                <div style="margin-bottom: 0.5rem;">
                    ${styleNames[style]}: ${stats.correct}/${stats.total} (${percentage}%)
                </div>
            `;
        }

        analysisHTML += `</div>
            <p style="color: orange; margin-top: 1rem;">(Modo fallback: an√°lisis local)</p>`;

        document.getElementById('learning-analysis').innerHTML = analysisHTML;

        if (score >= 15) {
            confetti({
                particleCount: 150,
                spread: 90,
                origin: { y: 0.6 }
            });
        }
    }
}
    function goToMainApp() {
        window.location.href = 'BlueMindsMain.html';
    }

    function render() {
        if (currentQuestionIndex < 0 || currentQuestionIndex >= questions.length) {
            console.warn(`√çndice inv√°lido: ${currentQuestionIndex}. Reseteando a 0.`);
            currentQuestionIndex = 0;
        }

        const current = questions[currentQuestionIndex];
        const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
        currentQuestionType = current.type;

        document.getElementById('progress-bar').style.width = progress + '%';
        document.getElementById('progress-text').textContent = Math.round(progress) + '%';
        document.getElementById('question-title').textContent = current.question;
        document.getElementById('question-subtitle').textContent = current.subtitle + ` (${currentQuestionIndex + 1}/${questions.length})`;

        const contentEl = document.getElementById('question-content');
        contentEl.innerHTML = '';

        if (current.type === 'sound' || current.type === 'sound-complete') {
            contentEl.innerHTML = `
                <button onclick="playSound()" class="sound-play-button">
                    <i class="fas fa-volume-up" style="font-size: 3rem; color: white;"></i>
                </button>
                <div class="animal-options-container">
                    ${current.options.map(opt => `
                        <div onclick="handleSelection('${opt.value}')"
                             class="animal-option ${selectedAnswer === opt.value ? 'selected' : ''}">
                            <span class="animal-emoji">${opt.emoji}</span>
                            <span class="animal-name">${opt.label || opt.animal}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        } else if (current.type === 'sequence' || current.type === 'drag-sequence') {
            contentEl.innerHTML = `
                <div class="sequence-slots">
                    ${Array(current.correct.length).fill().map((_, i) => {
                        const val = sequenceAnswer[i];
                        if (val) {
                            return `<div class="sequence-box filled">
                                ${val}
                                <button class="remove-slot-btn" data-slot-index="${i}">√ó</button>
                            </div>`;
                        } else {
                            return `<div class="sequence-box drop-zone" data-slot-index="${i}"></div>`;
                        }
                    }).join('')}
                </div>
                <div class="options-pool">
                    ${current.options.filter(opt => !sequenceAnswer.includes(opt)).map(opt => `
                        <div class="draggable-item" data-value="${opt}">${opt}</div>
                    `).join('')}
                </div>
            `;
        } else if (current.type === 'complete-sequence') {
            const optionsMap = {};
            current.options.forEach(opt => optionsMap[opt.value] = opt.emoji);

            let slotIdx = 0;
            const sequenceHtml = current.sequence.map(item => {
                if (item === '?') {
                    const idx = slotIdx++;
                    const val = sequenceAnswer[idx];
                    if (val) {
                        const display = optionsMap[val] || val;
                        return `<div class="sequence-box filled">
                            ${display}
                            <button class="remove-slot-btn" data-slot-index="${idx}">√ó</button>
                        </div>`;
                    } else {
                        return `<div class="sequence-box drop-zone" data-slot-index="${idx}"></div>`;
                    }
                } else {
                    return `<div class="sequence-box fixed">${item}</div>`;
                }
            }).join('');

            contentEl.innerHTML = `
                <div class="sequence-slots">
                    ${sequenceHtml}
                </div>
                <div class="options-pool">
                    ${current.options.filter(opt => !sequenceAnswer.includes(opt.value)).map(opt => `
                        <div class="draggable-item" data-value="${opt.value}">
                            ${opt.emoji}
                        </div>
                    `).join('')}
                </div>
            `;
        } else if (current.type === 'image-to-word') {
            contentEl.innerHTML = `
                <div style="text-align: center; margin: 2rem 0;">
                    <div style="font-size: 8rem; margin-bottom: 2rem;">${current.image}</div>
                </div>
                <div class="image-options-container">
                    ${current.options.map(word => `
                        <div onclick="handleSelection('${word}')"
                             class="image-option ${selectedAnswer === word ? 'selected' : ''}">
                            <span class="image-label">${word}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        } else if (current.type === 'word-to-image') {
            const pair = current.pairs[current.currentPair];
            contentEl.innerHTML = `
                <div style="text-align: center; margin: 2rem 0;">
                    <div style="font-size: 2rem; font-weight: 700; margin-bottom: 2rem; color: var(--gray-800);">
                        ${pair.word}
                    </div>
                    <div style="font-size: 8rem; margin-bottom: 2rem;">${pair.image}</div>
                    <p style="color: var(--gray-600); margin-bottom: 2rem;">¬øEs correcto?</p>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <button onclick="handlePairAnswer(true)" class="action-button" style="background: linear-gradient(135deg, var(--green-500), var(--green-600)); margin: 0;">
                        ‚úì S√ç
                    </button>
                    <button onclick="handlePairAnswer(false)" class="action-button" style="background: linear-gradient(135deg, var(--red-500), #dc2626); margin: 0;">
                        ‚úó NO
                    </button>
                </div>
            `;
        } else if (current.type === 'order-words') {
            if (current.audioText) {
                contentEl.innerHTML = `<button onclick="playSound()" class="sound-play-button"><i class="fas fa-volume-up" style="font-size: 3rem;"></i></button>`;
            }
            contentEl.innerHTML += `
                <div class="word-order-slots">
                    ${Array(current.correct.length).fill().map((_, i) => {
                        const val = wordOrderAnswer[i];
                        if (val) {
                            return `<div class="word-slot filled">
                                ${val}
                                <button class="remove-slot-btn" data-slot-index="${i}">√ó</button>
                            </div>`;
                        } else {
                            return `<div class="word-slot drop-zone" data-slot-index="${i}"></div>`;
                        }
                    }).join('')}
                </div>
                <div class="word-options-pool">
                    ${current.words.filter(w => !wordOrderAnswer.includes(w)).map(word => `
                        <div class="draggable-item" data-value="${word}">${word}</div>
                    `).join('')}
                </div>
            `;
        }


        attachDragAndDropListeners();
        updateVerifyButtonState();
    }

    function updateVerifyButtonState() {
        const current = questions[currentQuestionIndex];
        let isComplete = false;

        if (['sequence', 'drag-sequence', 'complete-sequence'].includes(current.type)) {
            isComplete = sequenceAnswer.every(v => v !== null);
        } else if (current.type === 'order-words') {
            isComplete = wordOrderAnswer.every(v => v !== null);
        } else if (current.type === 'word-to-image') {
            isComplete = pairAnswers.length === current.pairs.length;
        } else {
            isComplete = selectedAnswer !== null;
        }

        document.getElementById('verify-button').disabled = !isComplete;
    }

    function attachDragAndDropListeners() {
        const content = document.getElementById('question-content');
        if (!content) return;

        content.querySelectorAll('.draggable-item').forEach(item => {
            item.draggable = true;
            item.ondragstart = (e) => {
                draggedValue = e.target.dataset.value;
                e.target.classList.add('dragging');
            };
            item.ondragend = (e) => {
                e.target.classList.remove('dragging');
            };
        });

        content.querySelectorAll('.drop-zone').forEach(zone => {
            zone.ondragover = (e) => {
                e.preventDefault();
                zone.classList.add('drag-over');
            };
            zone.ondragleave = (e) => zone.classList.remove('drag-over');
            zone.ondrop = (e) => {
                e.preventDefault();
                zone.classList.remove('drag-over');
                if (draggedValue) {
                    const slotIndex = parseInt(zone.dataset.slotIndex);
                    if (['sequence', 'drag-sequence', 'complete-sequence'].includes(currentQuestionType)) {
                        sequenceAnswer[slotIndex] = draggedValue;
                    } else if (currentQuestionType === 'order-words') {
                        wordOrderAnswer[slotIndex] = draggedValue;
                    }
                    draggedValue = null;
                    updateVerifyButtonState();
                    render();
                }
            };
        });

        content.querySelectorAll('.remove-slot-btn').forEach(btn => {
            btn.onclick = (e) => {
                e.stopPropagation();
                const slotIndex = parseInt(btn.dataset.slotIndex);
                if (['sequence', 'drag-sequence', 'complete-sequence'].includes(currentQuestionType)) {
                    sequenceAnswer[slotIndex] = null;
                } else if (currentQuestionType === 'order-words') {
                    wordOrderAnswer[slotIndex] = null;
                }
                updateVerifyButtonState();
                render();
            };
        });
    }

    document.addEventListener('DOMContentLoaded', async () => {
        await loadQuizProgress();
        render();
    });
    </script>
</body>
</html>
