<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlueMinds - Juego de Categorizaci√≥n</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/ejemplo-minijuego.css">
</head>        .feedback.error {
            background: #fee2e2;
            color: #991b1b;
            display: block;
        }

        /* Modal de fin de juego */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-content h2 {
            font-size: 32px;
            color: #0066CC;
            margin-bottom: 15px;
        }

        .modal-content p {
            color: #666;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00B4D8 0%, #0066CC 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: 800;
            margin: 20px auto;
        }

        @media (max-width: 768px) {
            .game-container {
                padding: 20px;
            }

            .game-header {
                flex-direction: column;
                align-items: stretch;
            }

            .options {
                grid-template-columns: 1fr;
            }

            .game-stats {
                width: 100%;
                justify-content: space-around;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Header -->
        <div class="game-header">
            <div class="game-title">
                <i class="fas fa-gamepad"></i> Categorizaci√≥n
            </div>
            <div class="game-stats">
                <div class="stat">
                    <div class="stat-label">Nivel</div>
                    <div class="stat-value" id="levelDisplay">1</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Aciertos</div>
                    <div class="stat-value" id="scoreDisplay">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Pregunta</div>
                    <div class="stat-value" id="questionDisplay">1/5</div>
                </div>
            </div>
        </div>

        <!-- Barra de progreso -->
        <div class="progress-section">
            <div class="progress-label">
                <span>Progreso de sesi√≥n</span>
                <span id="progressPercent">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <!-- Contenido del juego -->
        <div class="game-content">
            <div class="question">
                <div class="question-text" id="questionText">¬øA qu√© categor√≠a pertenece?</div>
                <div class="question-image" id="questionImage">üçé</div>
            </div>

            <div class="options" id="optionsContainer"></div>

            <div class="feedback" id="feedback"></div>
        </div>

        <!-- Botones -->
        <div class="game-buttons">
            <button class="btn btn-primary" id="submitBtn" onclick="submitAnswer()" disabled>
                <i class="fas fa-check"></i> Confirmar
            </button>
            <button class="btn btn-secondary" onclick="goBack()">
                <i class="fas fa-arrow-left"></i> Volver
            </button>
        </div>
    </div>

    <!-- Modal de fin -->
    <div class="modal" id="finishModal">
        <div class="modal-content">
            <h2 id="finalTitle">¬°Felicidades!</h2>
            <div class="score-circle" id="finalScore">0</div>
            <p id="finalMessage"></p>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="restartGame()" style="flex: 1;">
                    <i class="fas fa-redo"></i> Reintentar
                </button>
                <button class="btn btn-secondary" onclick="goBack()" style="flex: 1;">
                    <i class="fas fa-home"></i> Ir al Perfil
                </button>
            </div>
        </div>
    </div>

    <!-- Cargar API -->
    <script src="../api.js"></script>
    <script>
        // Variables del juego
        const GAME_ID = 'categorizacion';
        const GAME_TITLE = 'Categorizaci√≥n';
        const TOTAL_QUESTIONS = 5;

        let currentUser = null;
        let gameData = {
            level: 1,
            score: 0,
            currentQuestion: 0,
            selectedAnswer: null,
            totalTime: 0,
            startTime: Date.now(),
            answers: []
        };

        // Datos de ejemplo para las preguntas
        const questions = [
            { image: 'üçé', text: '¬øA qu√© categor√≠a pertenece?', options: ['Fruta', 'Vegetal', 'Carne', 'L√°cteo'], correct: 0 },
            { image: 'ü•ï', text: '¬øA qu√© categor√≠a pertenece?', options: ['Fruta', 'Vegetal', 'Carne', 'L√°cteo'], correct: 1 },
            { image: 'üê±', text: '¬øQu√© animal es?', options: ['Perro', 'Gato', 'Pajaro', 'Pez'], correct: 1 },
            { image: 'üöó', text: '¬øQu√© medio de transporte es?', options: ['Auto', 'Bicicleta', 'Barco', 'Avi√≥n'], correct: 0 },
            { image: 'üè†', text: '¬øQu√© es?', options: ['Casa', '√Årbol', 'Monta√±a', 'R√≠o'], correct: 0 }
        ];

        // Inicializaci√≥n
        window.addEventListener('load', async () => {
            currentUser = api.getCurrentUser();
            
            if (!currentUser) {
                window.location.href = '../login.html';
                return;
            }

            // Cargar progreso del usuario
            await loadGameProgress();
            renderQuestion();
        });

        // Cargar progreso guardado
        async function loadGameProgress() {
            try {
                const progress = await api.getGameProgressById(currentUser.id, GAME_ID);
                if (progress && progress.level) {
                    gameData.level = progress.level;
                    gameData.score = progress.score;
                }
            } catch (error) {
                console.error('Error al cargar progreso:', error);
            }
        }

        // Renderizar pregunta
        function renderQuestion() {
            if (gameData.currentQuestion >= TOTAL_QUESTIONS) {
                finishGame();
                return;
            }

            const question = questions[gameData.currentQuestion];
            document.getElementById('questionText').textContent = question.text;
            document.getElementById('questionImage').textContent = question.image;
            document.getElementById('questionDisplay').textContent = `${gameData.currentQuestion + 1}/${TOTAL_QUESTIONS}`;
            document.getElementById('scoreDisplay').textContent = gameData.score;
            document.getElementById('levelDisplay').textContent = gameData.level;

            // Actualizar progreso visual
            const percentage = ((gameData.currentQuestion) / TOTAL_QUESTIONS) * 100;
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressPercent').textContent = Math.round(percentage) + '%';

            // Renderizar opciones
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option';
                button.textContent = option;
                button.onclick = () => selectOption(index);
                button.id = `option-${index}`;
                optionsContainer.appendChild(button);
            });

            document.getElementById('feedback').className = 'feedback';
            document.getElementById('submitBtn').disabled = true;
            gameData.selectedAnswer = null;
        }

        // Seleccionar opci√≥n
        function selectOption(index) {
            gameData.selectedAnswer = index;
            
            // Actualizar UI
            document.querySelectorAll('.option').forEach((el, i) => {
                el.classList.remove('selected');
                if (i === index) {
                    el.classList.add('selected');
                }
            });

            document.getElementById('submitBtn').disabled = false;
        }

        // Enviar respuesta
        function submitAnswer() {
            if (gameData.selectedAnswer === null) return;

            const question = questions[gameData.currentQuestion];
            const isCorrect = gameData.selectedAnswer === question.correct;

            // Feedback visual
            const feedbackEl = document.getElementById('feedback');
            const optionEl = document.getElementById(`option-${gameData.selectedAnswer}`);

            if (isCorrect) {
                gameData.score++;
                optionEl.classList.add('correct');
                feedbackEl.classList.add('success');
                feedbackEl.textContent = '¬°Correcto! üéâ';
            } else {
                optionEl.classList.add('incorrect');
                document.getElementById(`option-${question.correct}`).classList.add('correct');
                feedbackEl.classList.add('error');
                feedbackEl.textContent = '‚ùå Esa no es la respuesta correcta';
            }

            gameData.answers.push({
                question: gameData.currentQuestion,
                selected: gameData.selectedAnswer,
                correct: question.correct,
                isCorrect: isCorrect
            });

            // Deshabilitar opciones
            document.querySelectorAll('.option').forEach(el => el.disabled = true);

            // Pasar a siguiente despu√©s de 2 segundos
            setTimeout(() => {
                gameData.currentQuestion++;
                renderQuestion();
            }, 2000);
        }

        // Finalizar juego
        async function finishGame() {
            gameData.totalTime = Math.round((Date.now() - gameData.startTime) / 1000);
            
            const completionPercentage = (gameData.score / TOTAL_QUESTIONS) * 100;
            
            // Si el usuario complet√≥ correctamente, subir de nivel
            if (completionPercentage >= 80) {
                gameData.level++;
            }

            // Guardar progreso en servidor
            try {
                await api.updateGameProgress(
                    currentUser.id,
                    GAME_ID,
                    GAME_TITLE,
                    gameData.score,
                    gameData.level,
                    gameData.level,
                    completionPercentage,
                    gameData.totalTime
                );

                // Guardar sesi√≥n de terapia
                await api.saveTherapySession(
                    currentUser.id,
                    GAME_ID,
                    gameData.totalTime,
                    {
                        score: gameData.score,
                        level: gameData.level,
                        completionPercentage: completionPercentage,
                        answers: gameData.answers
                    }
                );
            } catch (error) {
                console.error('Error al guardar progreso:', error);
            }

            // Mostrar modal de fin
            showFinishModal(completionPercentage);
        }

        // Mostrar modal
        function showFinishModal(percentage) {
            const modal = document.getElementById('finishModal');
            const finalScore = document.getElementById('finalScore');
            const finalMessage = document.getElementById('finalMessage');
            const finalTitle = document.getElementById('finalTitle');

            finalScore.textContent = Math.round(percentage) + '%';

            if (percentage >= 80) {
                finalTitle.textContent = '¬°Excelente!';
                finalMessage.textContent = `¬°Completaste el nivel ${gameData.level - 1} correctamente! Pasaste al nivel ${gameData.level}.`;
            } else if (percentage >= 60) {
                finalTitle.textContent = '¬°Muy Bien!';
                finalMessage.textContent = `Obtuviste ${gameData.score} de ${TOTAL_QUESTIONS} aciertos. ¬°Sigue practicando!`;
            } else {
                finalTitle.textContent = 'Sigue Intentando';
                finalMessage.textContent = `Obtuviste ${gameData.score} de ${TOTAL_QUESTIONS} aciertos. ¬°Reintentar te ayudar√°!`;
            }

            modal.classList.add('active');
        }

        // Reintentar juego
        function restartGame() {
            gameData = {
                level: gameData.level,
                score: 0,
                currentQuestion: 0,
                selectedAnswer: null,
                totalTime: 0,
                startTime: Date.now(),
                answers: []
            };
            document.getElementById('finishModal').classList.remove('active');
            renderQuestion();
        }

        // Volver atr√°s
        function goBack() {
            window.location.href = '../pages/perfil.html';
        }
    </script>
</body>
</html>